<!DOCTYPE html>
{% extends "base.html" %}
{% load static %}
<head>

{% block heading %}
<meta charset="utf-8">
<link rel="stylesheet" type="text/css" href="{% static 'css/index.css' %}" />
<script src="{% static 'js/jquery-1.11.2.js' %}"></script>
<script>
       $(document).ready(function(){
		/*initializing js object of all the selected servers,
		later to be used to maintain the couters object for each server*/		 
		selected_servers_object = {};
		selected_servers_name_list = ['ger_server'];
		
		function x(){
			selected_servers_name_list = []
			//js array with the list of selected servers
	 	    $("input[type=checkbox]:checked").each(function() {
			        selected_servers_name_list.push($(this).val());
		    });
		    //alert(JSON.stringify(selected_servers_name_list));
			$.post('/mypy/', { server_list_from_jquery: JSON.stringify(selected_servers_name_list),
					           csrfmiddlewaretoken: '{{ csrf_token }}',
					          }, 
					function(json_response){
						selected_servers_object = {};
						selected_servers_object = JSON.parse(json_response);
						insert_data();
			});
			loop();
		}
		
		function loop() {
			setTimeout(x, 5000);
		}
		loop();

		
		function get_server_checklist() {
			selected_servers_name_list = [];
			$("input[type=checkbox]:checked").each(function() {
			        selected_servers_name_list.push($(this).val());
		        });
		    return selected_servers_name_list;
		}
		
		//setting the default monitor group to general_info for landing page
		current_monitor = "general_info";
		//$("#" + current_monitor).attr('disabled', 'disabled'); 
		var general_info_counters = "<div class='monitor_group'>" +
			                                        "<ul>" +
			                                            "<li class='counters_list_css' id='available'>Available?</li>" +
			                                            "<li class='counters_list_css' id='version'>Version</li>" +
			                                            "<li class='counters_list_css' id='running_for'>Running for</li>" +
			                                            "<li class='counters_list_css' id='start_time'>Start time</li>" +
			                                            "<li class='counters_list_css' id='default_storage_engine'>Default storage engine</li>" +
			                                            "<li class='counters_list_css' id='innodb_version'>InnoDB version</li>" +
			                                        "</ul>" +
			                                    "</div>";
		$("#server_details").prepend(general_info_counters);
		//this selector describes which monitor has been selected currently
	    //only one monitor group can be selected at one time 
		$("input.tab").click(function(){
			if(current_monitor==$(this).attr("id")) {
				return false;
			}
			current_monitor = $(this).attr("id");
			//alert(current_monitor);
			switch(current_monitor){
			    case "general_info":
			        $(".monitor_group").remove();
			        var general_info_counters = "<div class='monitor_group'>" +
			                                        "<ul>" +
			                                            "<li class='counters_list_css' id='available'>Available?</li>" +
			                                            "<li class='counters_list_css' id='version'>Version</li>" +
			                                            "<li class='counters_list_css' id='running_for'>Running for</li>" +
			                                            "<li class='counters_list_css' id='start_time'>Start time</li>" +
			                                            "<li class='counters_list_css' id='default_storage_engine'>Default storage engine</li>" +
			                                            "<li class='counters_list_css' id='innodb_version'>InnoDB version</li>" +
			                                        "</ul>" +
			                                    "</div>";
		            $("#server_details").prepend(general_info_counters);
		            insert_data();
		            break;
		        
		        case "connection_history":
		            $(".monitor_group").remove();
		            var connection_history_counters = "<div class='monitor_group'>" +
			                                              "<ul>" +
			                                                  "<li class='counters_list_css' id='attempts'>Attempts</li>" +
			                                                  "<li class='counters_list_css' id='successful'>Successful</li>" +
			                                                  "<li class='counters_list_css' id='percentage_of_max_allowed_reached'>Percentage of max allowed reached</li>" +
			                                                  "<li class='counters_list_css' id='refused'>Refused</li>" +
			                                                  "<li class='counters_list_css' id='percentage_of_refused_connections'>Percentage of refused connections</li>" +
			                                                  "<li class='counters_list_css' id='terminated_abruptly'>Terminated abruptly</li>" +
			                                              "</ul>" +
			                                          "</div>";
			        $("#server_details").prepend(connection_history_counters);
			        insert_data();
			        break;
         }
		});
         
        
        function insert_data() {
			//var s1 = JSON.parse(selected_servers_object);
			//alert(selected_servers_object.ger_server.general_info['version']);
			var total_counters = parseInt($(".monitor_group li").length);
			//alert(total_counters);
			for(var server_name in selected_servers_object) {
				var index = 0;
				for(index=0; index<total_counters; index++) {
					//alert("inside nest");
					var current_list_element = $(".monitor_group li:eq(" + index + ")");
					var current_counter_value = eval("selected_servers_object[server_name]." + current_monitor + "['" + 
					                                  current_list_element.attr('id') + "']");
					//alert(current_counter_value);
					$("#" + server_name + " li:eq(" + index + ")").text(current_counter_value);
				}
			}
		}
		//this selector describes which servers are being currently selected
		//more than one server can be selected at a time
		//it sends a ajax post request to the index view and returns the json data
		$("#server_list_form :checkbox").change(function(){
			var $this = $(this);
			//alert("inside checkbox");
			//checking is the server checkbox is checked and appending the serever details
			if($this.is(':checked')){
				var server_selection = $this.val();
				//selected_servers_name_list = []
				//$("input[type=checkbox]:checked").each(function() {
					//selected_servers_name_list.push($(this).val());
				//});
				
				//alert(selected_servers_name_list);
				/*selected_servers_name_list = [];
				for(var server_name in selected_servers_object) {
					//alert(server_name);
					if(selected_servers_name_list.indexOf(server_name) == -1) {
						selected_servers_name_list.push(server_name);
					}
				}
				if(selected_servers_name_list.indexOf(server_selection) == -1) {
						selected_servers_name_list.push(server_selection);
				}*/
				
				//alert(selected_servers_name_list);		
				$.post('/mypy/', { server_list_from_jquery: JSON.stringify(get_server_checklist()), 
					               csrfmiddlewaretoken: '{{ csrf_token }}',
					              }, 
					function(json_response){
						//alert(JSON.stringify(get_server_checklist()));
					    var counters_dict = JSON.parse(json_response);
					    var response_dict = counters_dict[server_selection];
					    //alert(response_dict[server_selection]);
					    //updating js object of all the current checked server with its respective counter
					    selected_servers_object[$this.val()] = response_dict;
					    
					    var total_counters = parseInt($(".monitor_group li").length);					
					    var i;
					    var counters_list = "";
					    /*creating the counters list from the json response_dict for the server to be appeneded*/
					    for(i=0; i<total_counters; i++) {
							counters_list += "<li class='counters_list_css'>" + 
							                 eval('response_dict.' + current_monitor + "." + 
							                 $(".monitor_group li:eq(" + i + ")").attr('id')) + "</li>";
							}
						
						/*building the html_response to be appeneded*/						
					    var html_response = "<div class='server_class' id='" + $this.val() + "'>" +
						                        "<div class='server_heading'>" + server_selection + "</div>" + 
						                            "<ul class='server_counters_list'>" +
						                                counters_list +
						                            "</ul>" +
						                     "</div>";    
						$(".monitor_group").after(html_response);
						//alert(JSON.stringify(selected_servers_object));
						});
					}
			
			else{
				//removing the current server and its couters object from the selected_servers object
				delete selected_servers_object[$this.val()];
				$("#" + $this.val()).remove();
				//alert(selected_servers_name_list);
			}
				});
			
		});
		
</script>
<h1>MyPy</h1>
{% endblock %}


</head>

<body>
    {% block body_tag %}
        <input type="button" class="tab" value="General Info" id="general_info" />
        
        <input type="button" class="tab" value="Connection History" id="connection_history" 
        style="width: 10.8vw; left: 25.1vw;" />
        
        <input type="button" class="tab" value="Current Connections" id="current_connection" 
        style="width: 11.2vw; left: 36vw;" />
        
        <input type="button" class="tab" value="InnoDB Cache" id="innodb_cache" style="left: 47.3vw;" />
        
        <input type="button" class="tab" value="Threads" id="threads" style="width: 7.3vw; left: 55.7vw;" />
        
        <input type="button" class="tab" value="Query Cache" id="query_cache" style="left: 63.1vw;" />
        
        <input type="button" class="tab" value="Index usage" id="index_usage" style="left: 71.4vw;" />
        
        <input type="button" class="tab" value="Statements" id="statements" style="left: 79.8vw;" />
        
        <input type="button" class="tab" value="Replication" id="replication" style="left: 88.2vw;" />
        
        {% csrf_token %}
        <input type="hidden" name="ajax_test" method="post" />
        
        {% if server_list %}
    
	        <form action="/mypy/" method="post" id="server_list_form">
                {% csrf_token %}
                <ul id="side_list">
	                {% for server in server_list %}
	                
	                    <li class="side_list_padding">
	                        <input type="checkbox" name="selected_server_checkbox" value="{{server.mysql_server_name}}"/>
	                            {{ server.mysql_server_name }}
	                    </li>
	                {% endfor %}
	            </ul>
	            <!--Delete server will call the index view with the checkbox values as the POST request-->
	            <br>
	            <span>
	                <input type="submit" value="Delete" class="btn" name="delete_server" 
	                style="width: 5.5vw; left: 10.7vw;">
	                
	        </form>
	        <!--Add server will call the adding_server view-->
	        <form action="/mypy/add_server/" method="post" style="float: left;">
	            {% csrf_token %}
	            <input type="submit" value="Add Server" class="btn">
            </form>
                </span>
        {% endif %}
        <div id="server_details"></div>
        
    {% endblock %}
</body>

</html>
